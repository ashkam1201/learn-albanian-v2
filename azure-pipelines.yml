trigger:
- main

pool:
  name: Default

variables:
  projectPath: '.'
  # This MUST be the folder that contains index.html
  distPath: 'dist/learn-albanian-v2/browser'

steps:
- checkout: self

- script: |
    export NVM_DIR="$HOME/.nvm"
    source "$NVM_DIR/nvm.sh"
    nvm use 22
    node -v
    npm -v
  displayName: 'Use Node 22 (nvm)'

- script: |
    export NVM_DIR="$HOME/.nvm"
    source "$NVM_DIR/nvm.sh"
    nvm use 22
    cd "$(projectPath)"
    npm ci
  displayName: 'Install dependencies'

- script: |
    export NVM_DIR="$HOME/.nvm"
    source "$NVM_DIR/nvm.sh"
    nvm use 22
    cd "$(projectPath)"
    npx ng build --configuration production
  displayName: 'Build Angular (production)'

# Optional: confirm index.html location in logs
- script: |
    cd "$(projectPath)"
    echo "=== index.html locations ==="
    find dist -maxdepth 6 -name "index.html" -print
    echo "=== deploying from ==="
    ls -la "$(distPath)" || true
  displayName: 'Debug dist output'

# Deploy Angular build to DOMAIN ROOT (FTP root == Hostinger public_html)
- task: FtpUpload@2
  inputs:
    credentialsOption: 'inputs'
    serverUrl: 'ftp://$(FTP_HOST)'
    username: '$(FTP_USER)'
    password: '$(FTP_PASS)'
    rootDirectory: '$(System.DefaultWorkingDirectory)/$(projectPath)/$(distPath)'
    filePatterns: '**'
    remoteDirectory: '/'
    clean: false
    preservePaths: true
    trustSSL: false
  displayName: 'Deploy Angular to domain root'

# Deploy .htaccess to DOMAIN ROOT (make sure .htaccess exists in repo root)
- task: FtpUpload@2
  inputs:
    credentialsOption: 'inputs'
    serverUrl: 'ftp://$(FTP_HOST)'
    username: '$(FTP_USER)'
    password: '$(FTP_PASS)'
    rootDirectory: '$(System.DefaultWorkingDirectory)/$(projectPath)'
    filePatterns: '.htaccess'
    remoteDirectory: '/'
    clean: false
    preservePaths: false
    trustSSL: false
  displayName: 'Deploy .htaccess to domain root'
