trigger:
- main

pool:
  name: Default

variables:
  projectPath: '.'
  # CHANGE THIS after the first run based on the "Debug dist output" step
  distPath: 'dist'

steps:
- checkout: self

- script: |
    export NVM_DIR="$HOME/.nvm"
    source "$NVM_DIR/nvm.sh"
    nvm use 22
    node -v
    npm -v
  displayName: 'Use Node 22 (nvm)'

- script: |
    export NVM_DIR="$HOME/.nvm"
    source "$NVM_DIR/nvm.sh"
    nvm use 22
    cd "$(projectPath)"
    npm ci
  displayName: 'Install dependencies'

- script: |
    export NVM_DIR="$HOME/.nvm"
    source "$NVM_DIR/nvm.sh"
    nvm use 22
    cd "$(projectPath)"
    npx ng build --configuration production
  displayName: 'Build Angular (production)'

# Helpful: show what's inside dist so you can set distPath correctly
- script: |
    cd "$(projectPath)"
    echo "=== dist contents ==="
    ls -la dist || true
    echo "=== index.html locations ==="
    find dist -maxdepth 4 -name "index.html" -print
  displayName: 'Debug dist output'

# Optional safe debug (no password)
- script: |
    echo "FTP_HOST=$(FTP_HOST)"
    echo "FTP_USER=$(FTP_USER)"
    echo "REMOTE_DIR=$(REMOTE_DIR)"
    echo "DIST_DIR=$(System.DefaultWorkingDirectory)/$(projectPath)/$(distPath)"
  displayName: 'Debug FTP variables (safe)'

# Deploy build output via plain FTP
- task: FtpUpload@2
  inputs:
    credentialsOption: 'inputs'
    serverUrl: 'ftp://$(FTP_HOST)'
    username: '$(FTP_USER)'
    password: '$(FTP_PASS)'
    rootDirectory: '$(System.DefaultWorkingDirectory)/$(projectPath)/$(distPath)'
    filePatterns: '**'
    remoteDirectory: '$(REMOTE_DIR)'
    clean: true
    preservePaths: true
    trustSSL: false
  displayName: 'Deploy to Hostinger via FTP'

# OPTIONAL: deploy .htaccess from repo root
- task: FtpUpload@2
  inputs:
    credentialsOption: 'inputs'
    serverUrl: 'ftp://$(FTP_HOST)'
    username: '$(FTP_USER)'
    password: '$(FTP_PASS)'
    rootDirectory: '$(System.DefaultWorkingDirectory)/$(projectPath)'
    filePatterns: '.htaccess'
    remoteDirectory: '$(REMOTE_DIR)'
    clean: false
    preservePaths: false
    trustSSL: false
  displayName: 'Deploy .htaccess (optional)'
